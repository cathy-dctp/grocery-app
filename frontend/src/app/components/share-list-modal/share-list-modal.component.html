@if (isVisible) {
  <!-- Modal Backdrop -->
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    (click)="onClose()"
    (keydown.escape)="onClose()"
    role="dialog"
    aria-modal="true"
    tabindex="-1"
  >
    <!-- Modal Content -->
    <div
      class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-scale-in"
      (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()"
      role="document"
      tabindex="0"
    >
      <div class="p-6">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-xl font-heading font-semibold text-neutral-900">Share List</h2>
            <p class="text-sm text-neutral-600 font-sans mt-1">{{ groceryList?.name }}</p>
          </div>
          <button
            (click)="onClose()"
            class="p-2 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg transition-all duration-200"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Error/Success Messages -->
        @if (errorMessage()) {
          <div
            class="bg-error-50 border border-error-200 text-error-800 px-4 py-3 rounded-xl mb-4 animate-slide-up"
          >
            <div class="flex items-center">
              <svg
                class="h-4 w-4 mr-2 text-error-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span class="text-sm font-sans">{{ errorMessage() }}</span>
            </div>
          </div>
        }

        @if (successMessage()) {
          <div
            class="bg-success-50 border border-success-200 text-success-800 px-4 py-3 rounded-xl mb-4 animate-slide-up"
          >
            <div class="flex items-center">
              <svg
                class="h-4 w-4 mr-2 text-success-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
              <span class="text-sm font-sans">{{ successMessage() }}</span>
            </div>
          </div>
        }

        <!-- User Search -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-neutral-700 mb-2 font-sans">
            Search for users to share with:
          </label>
          <div class="relative">
            <input
              type="text"
              [(ngModel)]="searchQuery"
              (input)="onSearchInput(searchQuery)"
              placeholder="Enter username..."
              class="w-full px-4 py-3 border border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 font-sans"
              data-cy="share-search-input"
            />
            @if (isSearching()) {
              <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                <svg class="animate-spin h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24">
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </div>
            }
          </div>

          <!-- Search Results -->
          @if (searchResults().length > 0 && searchQuery.length >= 2) {
            <div
              class="mt-2 bg-white border border-neutral-200 rounded-xl shadow-lg max-h-40 overflow-y-auto"
            >
              @for (user of searchResults(); track user.id) {
                <button
                  (click)="shareWithUser(user.username)"
                  [disabled]="isLoading()"
                  class="w-full text-left px-4 py-3 hover:bg-neutral-50 transition-colors duration-200 border-b border-neutral-100 last:border-b-0 disabled:opacity-50 disabled:cursor-not-allowed"
                  data-cy="share-user-option"
                >
                  <div class="flex items-center">
                    <div
                      class="h-8 w-8 bg-gradient-to-r from-primary-400 to-secondary-400 rounded-full flex items-center justify-center mr-3"
                    >
                      <span class="text-white text-sm font-medium">{{
                        user.username.charAt(0).toUpperCase()
                      }}</span>
                    </div>
                    <div>
                      <div class="font-medium text-neutral-900 text-sm font-sans">
                        {{ user.username }}
                      </div>
                      @if (user.first_name || user.last_name) {
                        <div class="text-xs text-neutral-500 font-sans">
                          {{ user.first_name }} {{ user.last_name }}
                        </div>
                      }
                    </div>
                  </div>
                </button>
              }
            </div>
          } @else if (searchQuery.length >= 2 && searchResults().length === 0 && !isSearching()) {
            <div class="mt-2 text-sm text-neutral-500 font-sans px-4 py-3 bg-neutral-50 rounded-xl">
              No users found matching "{{ searchQuery }}"
            </div>
          }
        </div>

        <!-- Currently Shared Users -->
        @if (groceryList?.shared_with && (groceryList?.shared_with?.length ?? 0) > 0) {
          <div class="border-t border-neutral-200 pt-6">
            <h3 class="text-sm font-medium text-neutral-700 mb-3 font-sans">
              Currently shared with:
            </h3>
            <div class="space-y-2">
              @for (user of groceryList?.shared_with || []; track user.id) {
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-xl">
                  <div class="flex items-center">
                    <div
                      class="h-8 w-8 bg-gradient-to-r from-primary-400 to-secondary-400 rounded-full flex items-center justify-center mr-3"
                    >
                      <span class="text-white text-sm font-medium">{{
                        user.username.charAt(0).toUpperCase()
                      }}</span>
                    </div>
                    <div>
                      <div class="font-medium text-neutral-900 text-sm font-sans">
                        {{ user.username }}
                      </div>
                      @if (user.first_name || user.last_name) {
                        <div class="text-xs text-neutral-500 font-sans">
                          {{ user.first_name }} {{ user.last_name }}
                        </div>
                      }
                    </div>
                  </div>
                  <button
                    (click)="removeUser(user.username)"
                    [disabled]="isLoading()"
                    class="p-2 text-neutral-400 hover:text-error-500 hover:bg-error-50 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    data-cy="remove-shared-user"
                    title="Remove user from shared list"
                  >
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              }
            </div>
          </div>
        }

        <!-- Modal Actions -->
        <div class="flex justify-end pt-6 border-t border-neutral-200 mt-6">
          <button
            (click)="onClose()"
            class="px-6 py-3 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-xl transition-colors duration-200 font-heading"
            data-cy="share-modal-close"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}
