<div class="relative w-full max-w-md">
  <div class="relative flex items-center">
    <input
      type="text"
      class="w-full px-3 py-2 pr-12 text-sm bg-white border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
      [formControl]="searchControl"
      [placeholder]="placeholder"
      (focus)="onInputFocus()"
      (blur)="onInputBlur()"
      (keydown)="onKeyDown($event)"
      autocomplete="off"
      role="combobox"
      [attr.aria-expanded]="showDropdown()"
      aria-haspopup="listbox"
    >
    
    @if (searchControl.value) {
      <button 
        type="button" 
        class="absolute right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 flex items-center justify-center text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-full transition-all duration-200"
        (click)="clearInput()"
        aria-label="Clear search"
      >
        Ã—
      </button>
    }
    
    @if (isLoading()) {
      <div class="absolute right-4 top-1/2 transform -translate-y-1/2" aria-label="Loading">
        <div class="w-4 h-4 border-2 border-neutral-200 border-t-primary-500 rounded-full animate-spin"></div>
      </div>
    }
  </div>

  @if (showDropdown()) {
    <div class="absolute top-full left-0 right-0 bg-white border border-neutral-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 mt-1" role="listbox">
      @for (item of suggestions(); track $index) {
        <div 
          class="px-4 py-3 cursor-pointer border-b border-neutral-100 last:border-b-0 hover:bg-neutral-50 transition-colors duration-150"
          [class.bg-neutral-50]="selectedIndex() === $index"
          [class.bg-green-50]="item.isCreateNew"
          [class.hover:bg-green-100]="item.isCreateNew"
          (click)="selectItem(item)"
          role="option"
          [attr.aria-selected]="selectedIndex() === $index"
        >
          @if (item.isCreateNew) {
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2 font-medium text-green-600 text-sm">
                <span class="font-bold text-base">+</span>
                {{ item.name }}
              </div>
              <div class="text-xs text-neutral-500 italic">{{ item.category_name }}</div>
            </div>
          } @else {
            <div class="flex flex-col gap-1">
              <div class="font-medium text-neutral-900 text-sm">{{ item.name }}</div>
              <div class="flex items-center gap-2 text-xs text-neutral-500">
                <span class="bg-neutral-200 px-2 py-1 rounded text-xs">{{ item.category_name }}</span>
                @if (item.default_unit) {
                  <span class="italic">{{ item.default_unit }}</span>
                }
              </div>
            </div>
          }
        </div>
      } @empty {
        <div class="px-4 py-4 text-center text-neutral-500 italic">
          No items found
        </div>
      }
    </div>
  }
</div>