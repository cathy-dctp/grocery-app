<div class="grocery-list-detail">
  @if (list()) {
    <div class="header">
      <div class="list-info">
        <a [routerLink]="['/lists']" class="back-link">← Back to Lists</a>
        <h1>{{ list()!.name }}</h1>
        <p class="list-meta">Created {{ list()!.created_at | date }}</p>
      </div>
    </div>

    <!-- Add Item Form - Always Visible -->
    <div class="add-item-section">
      <h2>Add Item to List</h2>
      <div class="add-item-form">
        <div class="form-grid">
          <div class="autocomplete-section">
            <label for="item-search">Search or create item:</label>
            <app-item-autocomplete
              id="item-search"
              placeholder="Start typing to search items..."
              (itemSelected)="onItemSelected($event)"
              (createNewItem)="onCreateNewItem($event)"
            ></app-item-autocomplete>
          </div>
          
          @if (isCreatingNewItem) {
            <!-- New Item Creation Form -->
            <div class="new-item-section">
              <h3>Create New Item: "{{ newItemName }}"</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="new-category">Category *</label>
                  <select 
                    id="new-category"
                    [(ngModel)]="selectedCategoryId"
                    (change)="onCategorySelectionChange()"
                    class="form-control"
                  >
                    <option value="0">Select a category</option>
                    @for (category of categories(); track category.id) {
                      <option [value]="category.id">{{ category.name }}</option>
                    }
                    <option value="-1">+ Create new category</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="new-unit">Default Unit *</label>
                  <select 
                    id="new-unit"
                    [(ngModel)]="newItemUnit"
                    class="form-control"
                  >
                    <option value="pcs">pieces</option>
                    <option value="lb">pounds</option>
                    <option value="kg">kilograms</option>
                    <option value="bag">bag</option>
                    <option value="box">box</option>
                    <option value="bottle">bottle</option>
                    <option value="can">can</option>
                    <option value="gallon">gallon</option>
                    <option value="dozen">dozen</option>
                    <option value="bunch">bunch</option>
                    <option value="container">container</option>
                  </select>
                </div>
              </div>
              
              @if (showCustomCategoryInput) {
                <div class="form-group">
                  <label for="custom-category">New Category Name *</label>
                  <input 
                    id="custom-category"
                    type="text" 
                    [(ngModel)]="customCategoryName" 
                    placeholder="Enter category name"
                    class="form-control"
                  >
                </div>
              }
              
              <div class="new-item-actions">
                <button 
                  type="button" 
                  class="create-item-btn"
                  (click)="createNewItemWithCategory()"
                  [disabled]="selectedCategoryId === 0 || (selectedCategoryId === -1 && !customCategoryName.trim())"
                >
                  Create & Select Item
                </button>
                <button type="button" class="cancel-btn" (click)="cancelNewItemCreation()">
                  Cancel
                </button>
              </div>
            </div>
          } @else if (selectedItem) {
            <!-- Selected Item Display -->
            <div class="selected-item-info">
              <span class="selected-label">Selected:</span>
              <strong>{{ selectedItem.name }}</strong>
              <span class="category-badge">{{ selectedItem.category_name }}</span>
            </div>
          }
          
          @if (selectedItem) {
            <div class="form-row">
              <div class="form-group">
                <label for="quantity">Quantity:</label>
                <input 
                  id="quantity"
                  type="text" 
                  [(ngModel)]="itemQuantity" 
                  placeholder="1" 
                  class="form-control"
                >
              </div>
              
              <div class="form-group">
                <label for="unit">Unit:</label>
                <input 
                  id="unit"
                  type="text" 
                  [(ngModel)]="itemUnit" 
                  [placeholder]="getSelectedItemUnit() || 'Unit'"
                  class="form-control"
                >
              </div>
            </div>
          }
        </div>
        
        <div class="form-actions">
          <button 
            class="add-btn" 
            (click)="addItemToList()" 
            [disabled]="!selectedItem"
          >
            Add to List
          </button>
          <button class="clear-btn" (click)="clearForm()">Clear</button>
        </div>
      </div>
    </div>

    @if (loading()) {
      <div class="loading">Loading items...</div>
    } @else if (error()) {
      <div class="error">{{ error() }}</div>
    } @else {
      <div class="items-container">
        @for (item of items(); track item.id) {
          <div class="item-row" [class.checked]="item.is_checked">
            <div class="item-checkbox">
              <input 
                type="checkbox" 
                [checked]="item.is_checked"
                (change)="toggleItemChecked(item)"
              >
            </div>
            <div class="item-info">
              <span class="item-name">{{ item.item_name }}</span>
              <span class="item-details">{{ item.quantity }} {{ item.unit }}</span>
              <span class="item-category">{{ item.item_category_name }}</span>
            </div>
            <button 
              class="remove-btn" 
              (click)="removeItemFromList(item.id)"
              title="Remove from list"
            >
              ×
            </button>
          </div>
        } @empty {
          <div class="empty-state">
            <h3>No items in this list yet</h3>
            <p>Add some items to get started!</p>
          </div>
        }
      </div>
    }
  } @else {
    <div class="loading">Loading list...</div>
  }
</div>